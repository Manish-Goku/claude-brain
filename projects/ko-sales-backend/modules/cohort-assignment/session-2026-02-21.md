# Session: Cohort Bulk Assignment — 2026-02-21

## What Was Built

### BullMQ Infrastructure
- Installed `@nestjs/bullmq` + `bullmq`
- `BullModule.forRootAsync()` in `app.module.ts` using `REDIS_HOST`/`REDIS_PORT`
- Added `REDIS_HOST=127.0.0.1`, `REDIS_PORT=6379` to `.env`

### Cohort Assignment Feature
**New files:**
- `schemas/cohort-assignment-job.schema.ts` — job tracking (CAJ-N)
- `dto/assign-cohort.dto.ts` — `{ agent_ids: string[] }`
- `services/cohort-assignment.service.ts` — validate → fetch leads → sync/async → weighted distribution
- `processors/cohort-assignment.processor.ts` — BullMQ `@Processor` worker

**Modified files:**
- `app.module.ts` — BullModule registration
- `leads/leads.service.ts` — added `find_by_pii_ids()`, `find_by_lead_ids_lean()`
- `cohorts/cohorts.controller.ts` — `POST :cohort_id/assign`, `GET assign-jobs/:job_id`
- `cohorts/cohorts.module.ts` — wired BullMQ queue, LeadsModule, AgentsModule, new providers

### Capacity-Weighted Distribution
- `agents/schemas/agent.schema.ts` — added `daily_capacity` (Number, default 50)
- `agents/agents.service.ts` — added `get_agent_capacity(agent_id)` (reads DB, swappable later)
- `cohort-assignment.service.ts` — `build_capacity_distribution()` + `flatten_distribution()`
  - Proportional: `agent_share = (capacity / total_capacity) * total_leads`
  - Remainder-based rounding for exact total

### API Contracts
- `POST /cohorts/:cohort_id/assign` `{ agent_ids }` → sync result (<100) or async job_id (>=100)
- `GET /cohorts/assign-jobs/:job_id` → job status with progress

## What's Left
- `get_agent_capacity()` currently reads `daily_capacity` from DB directly — needs dynamic logic later (capacity - already_assigned_today, etc.)
- No max-capacity guard yet (doesn't prevent assigning beyond capacity)
- No socket/realtime notification on job completion (could add later)
